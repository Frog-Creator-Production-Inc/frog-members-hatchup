openapi: 3.0.0
info:
  title: HatchUp
  version: 1.0.0
  description: HatchUpプロジェクトのAPIドキュメントです。
paths:
  /api/admin/check:
    get:
      summary: ユーザーが管理者かどうかをチェック
      tags:
        - Admin
      responses:
        '200':
          description: 正常応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  isAdmin:
                    type: boolean
                    description: ユーザーが管理者であれば true
                  source:
                    type: string
                    description: 管理者であることの確認元 ('database' または 'fallback')
                    enum:
                      - database
                      - fallback
                  user:
                    type: object
                    description: 認証されたユーザー情報
                    properties:
                      id:
                        type: string
                        description: ユーザーID
                      email:
                        type: string
                        description: ユーザーのメールアドレス
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/aiagent/messages:
    get:
      summary: セッションのメッセージ履歴を取得
      tags:
        - AI Agent
      parameters:
        - name: session_id
          in: query
          required: true
          schema:
            type: string
            description: 取得するメッセージセッションのID
      responses:
        '200':
          description: メッセージ履歴が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        created_at:
                          type: string
                          format: date-time
                        user_id:
                          type: string
                        session_id:
                          type: string
                        sender:
                          type: string
                        content:
                          type: string
                        metadata:
                          type: object
                          additionalProperties: true
        '400':
          description: クエリパラメータ 'session_id' が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      summary: AIメッセージをデータベースに保存
      tags:
        - AI Agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - sender
                - content
              properties:
                session_id:
                  type: string
                  description: メッセージが属するセッションのID
                sender:
                  type: string
                  description: メッセージの送信者
                content:
                  type: string
                  description: メッセージの内容
                metadata:
                  type: object
                  description: その他のメタデータ
                  nullable: true
                  additionalProperties: true
      responses:
        '200':
          description: メッセージが正常に保存された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message_id:
                    type: string
                    description: 保存されたメッセージのID
        '400':
          description: リクエストボディの必須フィールドが不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/aiagent/session:
    post:
      summary: 新しいチャットセッションを作成
      tags:
        - AI Agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: セッションを作成するユーザーのID
      responses:
        '200':
          description: セッションが正常に作成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    description: 作成されたセッションのID
        '400':
          description: リクエストボディの必須フィールドが不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
    get:
      summary: 特定のセッションの会話履歴を取得
      tags:
        - AI Agent
      parameters:
        - name: sessionId
          in: query
          required: true
          schema:
            type: string
            description: 取得するセッションのID
      responses:
        '200':
          description: 会話履歴が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  chatHistory:
                    type: array
                    items:
                      type: object
                      properties:
                        role:
                          type: string
                          description: メッセージの送信者（'user' または 'assistant'）
                          enum:
                            - user
                            - assistant
                        content:
                          type: string
                          description: メッセージの内容
        '400':
          description: クエリパラメータ 'sessionId' が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/aiagent/setup:
    get:
      summary: AIエージェント用データベースのセットアップ状態を確認
      tags:
        - AI Agent
      description: |
        SupabaseにAIエージェントに必要なテーブル（visa_types, visa_information, chat_sessions, messages）が
        存在するかどうかを確認します。テーブルが存在しない場合、手動でセットアップするためのSQLスクリプトを返します。
      responses:
        '200':
          description: |
            テーブルの存在確認が完了した際の応答。
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      success:
                        type: boolean
                        example: true
                      message:
                        type: string
                        example: AIエージェント用のテーブルは既に存在します
                      tables:
                        type: array
                        description: 既存のテーブルのダミーデータ
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                  - type: object
                    properties:
                      success:
                        type: boolean
                        example: false
                      message:
                        type: string
                        example: テーブルが存在しません。Supabaseダッシュボードで以下のSQLを実行してください。
                      sql:
                        type: string
                        description: テーブルを作成するためのSQLスクリプト
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/aiagent/test-microcms:
    get:
      summary: MicroCMSからインタビュー記事を取得して分析
      tags:
        - AI Agent
      responses:
        '200':
          description: 検索結果と分析データが正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  query:
                    type: string
                    description: 実行された直接検索クエリ
                  keywords:
                    type: array
                    items:
                      type: string
                    description: 実行されたキーワード検索
                  interviewResults:
                    type: object
                    properties:
                      directSearch:
                        type: number
                        description: 直接検索で見つかった記事数
                      keywordSearch:
                        type: number
                        description: キーワード検索で見つかった記事数
                      uniqueResults:
                        type: number
                        description: 重複を排除した合計記事数
                  analysis:
                    type: object
                    properties:
                      total:
                        type: number
                        description: 分析対象となった記事の総数
                      canadaJobs:
                        type: number
                        description: カナダでの仕事に関連する記事数
                  details:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        title:
                          type: string
                        slug:
                          type: string
                        isCanadaJob:
                          type: boolean
                        excerpt:
                          type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/aiagent:
    post:
      summary: 質問に基づいてAIエージェントが回答を生成
      tags:
        - AI Agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                  description: AIエージェントへの質問
                sessionId:
                  type: string
                  description: 会話セッションのID
                  nullable: true
                userId:
                  type: string
                  description: ユーザーID
                  nullable: true
                chatHistory:
                  type: array
                  description: 過去の会話履歴
                  items:
                    type: object
                    properties:
                      role:
                        type: string
                        enum:
                          - user
                          - assistant
                      content:
                        type: string
      responses:
        '200':
          description: 回答が正常に生成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  answer:
                    type: string
                    description: AIエージェントが生成した回答
                  sessionId:
                    type: string
                    description: 新しく生成された、または既存のセッションID
                  sources:
                    type: object
                    properties:
                      visa:
                        type: array
                        items:
                          type: object
                          properties:
                            title:
                              type: string
                            url:
                              type: string
                      courses:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            title:
                              type: string
                            school:
                              type: string
                            location:
                              type: string
                            tuition:
                              type: number
                      interviews:
                        type: array
                        items:
                          type: object
                          properties:
                            title:
                              type: string
                            slug:
                              type: string
                            publishedAt:
                              type: string
                              format: date-time
                  analysis:
                    type: object
                    properties:
                      total:
                        type: number
                        description: 分析対象となったインタビュー記事の総数
                      canadaJobs:
                        type: number
                        description: カナダでの仕事に関連するインタビュー記事数
                  recommendations:
                    type: object
                    properties:
                      migrationGoal:
                        type: string
                      futureOccupation:
                        type: object
                        properties:
                          id:
                            type: string
                          title:
                            type: string
                            nullable: true
                          industry:
                            type: string
                            nullable: true
                      courses:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            title:
                              type: string
                            school:
                              type: string
                            location:
                              type: string
                            tuition:
                              type: number
                    nullable: true
        '400':
          description: リクエストボディに質問が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/auth/content-snare-callback:
    get:
      summary: Content Snare OAuth コールバック
      description: |
        Content SnareのOAuth認証フローにおけるリダイレクトURIとして機能します。
        URLクエリパラメータから認証コード（`code`）を取得し、Supabaseを使ってアクセストークンとリフレッシュトークンを交換します。
        取得したリフレッシュトークンはデータベースに保存され、ユーザーは設定ページにリダイレクトされます。
      tags:
        - Auth
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Content Snareから付与された認証コード
        - name: state
          in: query
          required: false
          schema:
            type: string
          description: OAuthフローでセキュリティのために使用される任意の状態パラメータ
      responses:
        '302':
          description: |
            処理が完了し、ユーザーを別のページにリダイレクトします。
            リダイレクト先URLのクエリパラメータで成功またはエラーの状態が通知されます。
          headers:
            Location:
              schema:
                type: string
              description: リダイレクト先のURL（例：/settings?success=content_snare_connected または /settings?error=general）
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/cancel-subscription:
    post:
      summary: ユーザーのStripe定期購読をキャンセル
      description: |
        指定されたユーザーIDのStripe定期購読をキャンセルし、Supabaseのプロフィール情報を更新します。
      tags:
        - Cancel-subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: 購読をキャンセルするユーザーのID
                  format: uuid
      responses:
        '200':
          description: 購読が正常にキャンセルされた場合の応答
          content:
            text/plain:
              schema:
                type: string
                example: Subscription cancelled
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/admin/fetch-full-status:
    get:
      summary: Content Snareの統合情報を取得
      description: |
        指定された`request_id`に基づいて、Content SnareのAPIからリクエストの詳細、進捗状況、およびページ情報を取得します。
        このエンドポイントは管理者権限が必要です。
      tags:
        - Content-snare
      parameters:
        - name: request_id
          in: query
          required: true
          schema:
            type: string
          description: Content SnareのRequest ID、または`course_applications`テーブルのID
        - name: verbose
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: |
            `true`に設定すると、Content Snareからの応答内容をより詳細に含めます。
      responses:
        '200':
          description: 情報が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: Content SnareのRequest ID
                  name:
                    type: string
                    description: リクエストの名前
                  status:
                    type: string
                    description: リクエストのステータス
                  url:
                    type: string
                    description: Content Snare上のリクエストURL
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
                  progress:
                    type: object
                    description: 進捗状況に関する情報
                    properties:
                      total_fields:
                        type: number
                      done_fields:
                        type: number
                      percent:
                        type: number
                      completed_sections:
                        type: number
                      total_sections:
                        type: number
                  sections:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        status:
                          type: string
                  pages:
                    type: array
                    description: リクエスト内のページ情報（`verbose`が`true`の場合は詳細、それ以外は簡略化）
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        status:
                          type: string
                        fields_count:
                          type: number
                        done_fields_count:
                          type: number
                  client:
                    type: object
                    properties:
                      id:
                        type: number
                      name:
                        type: string
                      email:
                        type: string
                  has_unread_comments:
                    type: boolean
                  responses:
                    type: array
                    description: |
                      `verbose`が`true`の場合にのみ含まれる、提出された応答の詳細。
                    items:
                      type: object
        '400':
          description: クエリパラメータ `request_id` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: 管理者権限がない、またはContent Snareの認証情報がない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: Content SnareのRequest IDが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/admin/get-request-pages:
    get:
      summary: Content Snareリクエストのページ情報を取得 (レガシー)
      description: |
        指定された`request_id`に対応するContent Snareリクエストのページ情報のリストを取得します。
        このエンドポイントは、内部的に`fetch-full-status`エンドポイントを呼び出して結果を整形します。
      tags:
        - Content-snare
      parameters:
        - name: request_id
          in: query
          required: true
          schema:
            type: string
          description: Content SnareのRequest ID、または`course_applications`テーブルのID
      responses:
        '200':
          description: ページ情報が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  request_id:
                    type: string
                    description: Content SnareのRequest ID
                  pages:
                    type: array
                    items:
                      type: object
                      description: 簡略化されたページ情報
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        status:
                          type: string
                        fields_count:
                          type: number
                        done_fields_count:
                          type: number
        '400':
          description: クエリパラメータ `request_id` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: request_idは必須です
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: 認証情報が無効であるか、管理者権限がない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Content Snareの認証が必要です
        '404':
          description: 参照している内部APIでContent Snare Request IDが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Content Snareページ情報の取得に失敗しました
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/admin/get-request-status:
    get:
      summary: Content Snareの統合情報を取得 (レガシー)
      description: |
        指定された`request_id`に基づいて、Content Snareの全情報を取得し、旧形式のAPIレスポンスに変換して返します。
        このエンドポイントは、内部的に`fetch-full-status`エンドポイントを呼び出して結果を整形します。
        管理者権限が必要です。
      tags:
        - Content-snare
      parameters:
        - name: request_id
          in: query
          required: true
          schema:
            type: string
          description: Content SnareのRequest ID、または`course_applications`テーブルのID
        - name: verbose
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: |
            `true`に設定すると、Content Snareからの応答内容をより詳細に含めます。
      responses:
        '200':
          description: 情報が正常に取得され、レガシー形式に変換された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: Content SnareのRequest ID
                  name:
                    type: string
                    description: リクエストの名前
                  status:
                    type: string
                    description: リクエストのステータス
                  url:
                    type: string
                    description: Content Snare上のリクエストURL
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
                  progress:
                    type: object
                    description: 新しい形式の進捗情報オブジェクト
                  fields_count:
                    type: number
                    description: レガシー形式の総フィールド数
                  done_fields_count:
                    type: number
                    description: レガシー形式の完了済みフィールド数
                  completion_percentage:
                    type: number
                    description: レガシー形式の完了率
                  sections:
                    type: array
                    items:
                      type: object
                  pages:
                    type: array
                    items:
                      type: object
                  client:
                    type: object
                  has_unread_comments:
                    type: boolean
                  responses:
                    type: array
                    description: '`verbose`が`true`の場合にのみ含まれる'
                    items:
                      type: object
        '400':
          description: クエリパラメータ `request_id` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: request_idは必須です
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: 認証情報が無効であるか、管理者権限がない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Content Snareの認証が必要です
        '404':
          description: 参照している内部APIでContent Snare Request IDが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Content Snare情報の取得に失敗しました
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/admin/get-templates:
    get:
      summary: Content Snareのテンプレート一覧を取得
      description: |
        認証済みの管理者ユーザーとして、Content Snareに保存されているリクエストテンプレートの一覧を取得します。
        このAPIは、リフレッシュトークンを使用してアクセストークンを自動的に取得・更新します。
      tags:
        - Content-snare
      responses:
        '200':
          description: テンプレート一覧が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: テンプレートのID
                    name:
                      type: string
                      description: テンプレート名
                    slug:
                      type: string
                      description: テンプレートのスラッグ
                    created_at:
                      type: string
                      format: date-time
                    updated_at:
                      type: string
                      format: date-time
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: 管理者権限がない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 管理者権限が必要です
        '404':
          description: Content Snareトークンが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Content Snareトークンが見つかりません
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/admin/list-requests:
    get:
      summary: Content Snareのリクエスト一覧を取得
      description: |
        認証済みの管理者ユーザーとして、Content Snareの全リクエストの一覧を取得します。
        リクエスト一覧は、アプリケーション内の`course_applications`テーブルと関連付けられ、簡略化された形式で返されます。
      tags:
        - Content-snare
      responses:
        '200':
          description: リクエスト一覧が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: Content SnareのRequest ID
                    application_id:
                      type: string
                      nullable: true
                      description: 関連付けられたコース申請のID（存在しない場合は`null`）
                    name:
                      type: string
                      description: リクエストの名前
                    status:
                      type: string
                      description: リクエストのステータス
                    share_link:
                      type: string
                      description: リクエストへの共有リンク
                    due:
                      type: string
                      format: date-time
                      nullable: true
                      description: リクエストの期日
                    created_at:
                      type: string
                      format: date-time
                    updated_at:
                      type: string
                      format: date-time
                    last_activity_at:
                      type: string
                      format: date-time
                      nullable: true
                      description: 最終活動日時
                    folder_name:
                      type: string
                      nullable: true
                      description: リクエストが属するフォルダの名前
                    client_name:
                      type: string
                      nullable: true
                      description: クライアントのフルネーム
                    client_email:
                      type: string
                      nullable: true
                      description: クライアントのEメールアドレス
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: 管理者権限がない、またはContent Snareの認証情報がない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 管理者権限が必要です
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/auth-code:
    get:
      summary: Content SnareのOAuth認証URLを生成
      description: |
        OAuth 2.0の認可コードフローを開始するため、Content Snareの認証ページへのURLを生成します。
        ランダムな`state`値を生成してSupabaseに保存し、CSRF攻撃を防ぎます。
        このエンドポイントは認証済みユーザーのみが利用可能です。
      tags:
        - Content-snare
      responses:
        '200':
          description: 認証URLが正常に生成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  authUrl:
                    type: string
                    format: uri
                    description: Content SnareのOAuth認証ページへの完全なURL
                  state:
                    type: string
                    description: CSRF対策のために生成されたランダムな状態値
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/auth-status:
    get:
      summary: Content Snareとの認証ステータスを確認
      description: |
        Supabaseの`refresh_tokens`テーブルからContent Snareの認証情報をチェックし、トークンの有効性を検証します。
        リフレッシュトークンが有効であれば、新しいトークンに更新します。
        このエンドポイントは、クライアント側で連携ステータスを表示するために使用されます。
      tags:
        - Content-snare
      responses:
        '200':
          description: 認証ステータスの確認が正常に完了した場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  authenticated:
                    type: boolean
                    description: Content Snareとの連携が認証済みか
                  hasToken:
                    type: boolean
                    description: データベースにリフレッシュトークンが存在するか
                  tokenRefreshed:
                    type: boolean
                    description: リフレッシュトークンが正常に更新されたか
                  message:
                    type: string
                    description: ステータスに関する詳細メッセージ
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/check-status:
    post:
      summary: Content Snareのサブミッションステータスを取得
      description: |
        指定された`submissionId`に基づいて、Content Snareのサブミッションの詳細情報を取得します。
        このAPIは、複数の方法（環境変数、メモリ、Supabase）でアクセストークンを取得・更新し、Content SnareのAPIを呼び出します。
      tags:
        - Content-snare
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - submissionId
              properties:
                submissionId:
                  type: string
                  description: 取得するサブミッションのID
      responses:
        '200':
          description: サブミッション情報が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                description: Content Snare APIから返されるサブミッションオブジェクト
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  status:
                    type: string
                  completed_at:
                    type: string
                    format: date-time
                    nullable: true
                  client:
                    type: object
                    properties:
                      id:
                        type: number
                      full_name:
                        type: string
                      email:
                        type: string
        '400':
          description: リクエストボディに `submissionId` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: submissionId が必要です
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がないか、トークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 存在しないサブミッションIDを指定した場合など、Content Snare APIからのエラー応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/client-search:
    get:
      summary: Content SnareのクライアントをEメールアドレスで検索
      description: |
        指定されたEメールアドレスに一致するContent Snareのクライアント情報を検索します。
        このAPIは、複数の方法（環境変数、メモリ、Supabase）でアクセストークンを取得・更新し、Content SnareのAPIを呼び出します。
        認証済みのユーザーのみが利用可能です。
      tags:
        - Content-snare
      parameters:
        - name: email
          in: query
          required: true
          schema:
            type: string
            format: email
          description: 検索するクライアントのEメールアドレス
      responses:
        '200':
          description: 検索が正常に完了した場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  clients:
                    type: array
                    description: 検索結果として返されたクライアントのリスト
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        full_name:
                          type: string
                        email:
                          type: string
                        company:
                          type: string
                          nullable: true
                  success:
                    type: boolean
                    description: API呼び出しが成功したか
        '400':
          description: クエリパラメータ `email` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: emailクエリパラメータは必須です
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がないか、トークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/create-client:
    post:
      summary: Content Snareに新しいクライアントを作成
      description: |
        指定された名前とメールアドレスでContent Snareに新しいクライアントを作成します。
        作成前に既存のクライアントを検索し、存在する場合は新規作成せずにその情報を返します。
        このAPIは、複数の方法（メモリ、Supabase）でアクセストークンを取得・更新し、Content SnareのAPIを呼び出します。
        認証済みのユーザーのみが利用可能です。
      tags:
        - Content-snare
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - firstName
                - lastName
                - email
              properties:
                firstName:
                  type: string
                  description: クライアントの姓
                lastName:
                  type: string
                  description: クライアントの名
                email:
                  type: string
                  format: email
                  description: クライアントのEメールアドレス
      responses:
        '200':
          description: クライアントが正常に作成された、または既存のクライアント情報が返された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  client_id:
                    type: string
                    description: Content Snareで作成された、または既存のクライアントのID
                  success:
                    type: boolean
                    description: API呼び出しが成功したか
                  already_exists:
                    type: boolean
                    description: クライアントが既に存在していた場合に `true`
                  client_info:
                    type: object
                    description: 既存クライアントの詳細情報
                    properties:
                      id:
                        type: string
                      full_name:
                        type: string
                      email:
                        type: string
        '400':
          description: リクエストボディに必須パラメータが不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 'firstName, lastName, emailは必須です'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がない、またはトークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '422':
          description: クライアントは存在するが、詳細を取得できなかったなど、処理できないエンティティ
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: クライアントは既に存在しますが、詳細を取得できませんでした。
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/create-request:
    post:
      summary: Content Snareに新しいリクエストを作成
      description: |
        指定された`courseId`と`clientId`に基づいて、Content Snareに新しいリクエストを作成します。
        リクエスト作成前に、認証済みユーザーのプロファイル情報でContent Snareのクライアント情報を更新し、コースに紐づくテンプレートIDを使用します。
        このAPIは、複数の方法（メモリ、Supabase）でアクセストークンを取得・更新し、Content SnareのAPIを呼び出します。
      tags:
        - Content-snare
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - courseId
                - clientId
              properties:
                courseId:
                  type: string
                  description: リクエストの元となるコースのID
                clientId:
                  type: string
                  description: リクエストの宛先となるContent SnareクライアントのID
      responses:
        '200':
          description: リクエストとコース申請が正常に作成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  request_id:
                    type: string
                    description: Content Snareで作成されたリクエストのID
                  share_link:
                    type: string
                    format: uri
                    description: リクエストへの共有リンク
                  application_id:
                    type: string
                    description: Supabaseで作成されたコース申請のID
                  success:
                    type: boolean
        '400':
          description: 必須パラメータの不足、またはコースにテンプレートが設定されていない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がないか、トークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 指定されたコースまたはユーザーが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/create-submission:
    post:
      summary: Content Snareに新しいサブミッションを作成
      description: |
        指定されたクライアントIDとパッケージIDを使用して、Content Snareに新しいサブミッションを作成します。
        このAPIは、複数の方法（環境変数、メモリ、Supabase）でアクセストークンを取得・更新し、Content SnareのAPIを呼び出します。
        認証済みユーザーのみが利用可能です。
      tags:
        - Content-snare
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - clientId
                - packageId
              properties:
                clientId:
                  type: string
                  description: サブミッションを割り当てるクライアントのID
                packageId:
                  type: string
                  description: サブミッションの元となるパッケージのID
      responses:
        '200':
          description: サブミッションが正常に作成された場合の応答
          content:
            application/json:
              schema:
                type: object
                description: Content Snare APIから返されるサブミッションオブジェクト
                properties:
                  id:
                    type: string
                    description: 作成されたサブミッションのID
                  status:
                    type: string
                    description: サブミッションのステータス
                  package_id:
                    type: string
                    description: 使用されたパッケージのID
                  client_id:
                    type: string
                    description: 割り当てられたクライアントのID
        '400':
          description: リクエストボディに必須パラメータが不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: clientId と packageId が必須です
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がない、またはトークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/exchange-token:
    post:
      summary: Content Snareのアクセストークンをリフレッシュ
      description: |
        Supabaseに保存されているリフレッシュトークンを使用して、Content Snareの新しいアクセストークンを取得します。
        新しいリフレッシュトークンもデータベースに保存されます。
        このAPIは、アクセストークンの有効期限が切れた際に呼び出されることを想定しています。
      tags:
        - Content-snare
      responses:
        '200':
          description: トークンが正常にリフレッシュされた場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: 新しく生成されたアクセストークン
                  token_type:
                    type: string
                    example: Bearer
                    description: トークンのタイプ
                  expires_in:
                    type: number
                    description: トークンの有効期限（秒単位）
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がない、またはトークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/get-applications:
    get:
      summary: 認証済みユーザーのコース申請一覧を取得
      description: |
        認証済みのユーザーが申請した全てのコース申請情報と、それに紐づくコースの詳細情報を取得します。
        結果は申請が作成された新しい順にソートされます。
      tags:
        - Content-snare
      responses:
        '200':
          description: コース申請一覧が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  applications:
                    type: array
                    description: ユーザーのコース申請情報のリスト
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        user_id:
                          type: string
                        course_id:
                          type: string
                        status:
                          type: string
                        created_at:
                          type: string
                          format: date-time
                        updated_at:
                          type: string
                          format: date-time
                        request_url:
                          type: string
                          format: uri
                          nullable: true
                        content_snare_id:
                          type: string
                          nullable: true
                        content_snare_request_id:
                          type: string
                          nullable: true
                        course:
                          type: object
                          properties:
                            id:
                              type: string
                            name:
                              type: string
                            school_id:
                              type: string
                            category:
                              type: string
                            description:
                              type: string
                            content_snare_template_id:
                              type: string
                              nullable: true
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/get-request-status:
    get:
      summary: Content Snareリクエストの詳細情報を取得
      description: |
        ユーザーが所有するContent Snareリクエストの詳細情報（進捗状況、ページ、セクションなど）を取得します。
        リクエストIDは、アプリケーションIDまたはContent Snare自体のリクエストIDのいずれかで指定可能です。
        このAPIは、トークンが期限切れの場合に自動的に再発行して再試行するロジックを含みます。
      tags:
        - Content-snare
      parameters:
        - name: request_id
          in: query
          required: true
          schema:
            type: string
          description: 取得するリクエストのID（コース申請IDまたはContent SnareリクエストID）
        - name: verbose
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: |
            `true`の場合、ページの詳細情報やレスポンスデータなど、より詳細な情報を含めて返します。
            デフォルトは `false` です。
      responses:
        '200':
          description: リクエストの詳細が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: Content SnareリクエストのID
                  name:
                    type: string
                    description: リクエスト名
                  status:
                    type: string
                    description: リクエストのステータス
                  url:
                    type: string
                    format: uri
                    description: Content Snareプラットフォーム上のリクエストURL
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
                  progress:
                    type: object
                    description: リクエストの進捗状況
                    properties:
                      total_fields:
                        type: number
                        description: 全フィールド数
                      done_fields:
                        type: number
                        description: 完了したフィールド数
                      percent:
                        type: number
                        description: 進捗率（パーセンテージ）
                      completed_sections:
                        type: number
                        description: 完了したセクション数
                      total_sections:
                        type: number
                        description: 全セクション数
                  sections:
                    type: array
                    description: リクエスト内のセクションリスト
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        status:
                          type: string
                  pages:
                    type: array
                    description: リクエスト内のページリスト（`verbose`が`false`の場合は簡略化）
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        status:
                          type: string
                  client:
                    type: object
                    description: 関連するクライアント情報
                    properties:
                      id:
                        type: string
                      full_name:
                        type: string
                      email:
                        type: string
                  has_unread_comments:
                    type: boolean
                  share_link:
                    type: string
                    format: uri
                  due:
                    type: string
                    format: date-time
                    nullable: true
                  folder_name:
                    type: string
                  last_activity_at:
                    type: string
                    format: date-time
                    nullable: true
                  responses:
                    type: array
                    description: |
                      `verbose=true`の場合にのみ含まれる、ユーザーの回答データ
                    items:
                      type: object
                    nullable: true
        '400':
          description: クエリパラメータ `request_id` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: ユーザーが指定されたリクエストへのアクセス権限を持っていない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 指定されたIDに対応するContent Snareリクエストが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/oauth-direct:
    get:
      summary: Content SnareのOAuth認証URLを生成
      description: |
        Content Snareとの連携に必要なOAuth認証プロセスを開始するためのURLを生成します。
        このURLは、指定された`client_id`、`redirect_uri`、および必要なスコープを含んでいます。
        認証済みのユーザーのみが利用可能です。
      tags:
        - Content-snare
      responses:
        '200':
          description: 認証URLが正常に生成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                    description: Content SnareのOAuth認証ページへの完全なURL
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/refresh-token:
    get:
      summary: ユーザーのContent Snareアクセストークンをリフレッシュ
      description: |
        認証済みユーザーのContent Snareリフレッシュトークンを使用して、新しいアクセストークンを取得します。
        新しいリフレッシュトークンはデータベースに更新され、アクセストークンはレスポンスとして返されます。
        リフレッシュトークンが無効な場合は、データベースから削除し、再認証を促します。
      tags:
        - Content-snare
      responses:
        '200':
          description: トークンが正常にリフレッシュされた場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  expiresAt:
                    type: string
                    format: date-time
                    description: 新しいアクセストークンの有効期限
                  access_token:
                    type: string
                    description: 新しく生成されたアクセストークン
        '401':
          description: 認証セッションがない、またはリフレッシュトークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 認証が必要です
                  requireReauth:
                    type: boolean
                    description: リフレッシュトークンが無効で再認証が必要な場合に `true`
        '404':
          description: ユーザーのリフレッシュトークンが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: リフレッシュトークンが見つかりません
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/content-snare/webhook:
    post:
      summary: Content SnareからのWebhook通知を処理
      description: |
        Content Snareから送信されるWebhookイベント（例：リクエストの提出、承認、却下）を受信して処理します。
        リクエストIDを基にSupabaseの`course_applications`テーブルを更新し、提出イベントの場合はSlackに通知を送信します。
        このエンドポイントは認証を必要としません。
      tags:
        - Content-snare
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event
                - request_id
              properties:
                event:
                  type: string
                  description: 発生したイベントのタイプ（例：`request.submitted`）
                request_id:
                  type: string
                  description: イベントに関連するContent SnareリクエストのID
      responses:
        '200':
          description: Webhookイベントが正常に処理された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: 無効なWebhookデータ（`event`または`request_id`が不足）の場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 関連するコース申請がデータベースに見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/course-application/create:
    post:
      summary: コース申請、Content Snareリクエスト、およびユーザーのスケジュールを作成
      description: |
        指定された`courseId`、`clientId`、および`intake_date_id`に基づいて、ユーザーのコース申請を作成します。
        この処理には、Supabaseでの以下の操作が含まれます。
        1. 認証済みユーザーのプロファイル情報でContent Snareクライアント情報を更新。
        2. コースに紐づくテンプレートIDを使用してContent Snareに新しいリクエストを作成。
        3. `course_applications`テーブルに申請データを保存。
        4. 選択された入学日情報に基づいて`user_schedules`テーブルに予定を作成。
        5. 内部APIを介してSlackに通知を送信。
        アクセストークンは、メモリ、Supabase、またはリフレッシュによって自動的に取得・更新されます。
      tags:
        - Course-application
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - courseId
                - clientId
                - intake_date_id
              properties:
                courseId:
                  type: string
                  description: 申請するコースのID
                clientId:
                  type: string
                  description: 関連するContent SnareクライアントのID
                intake_date_id:
                  type: string
                  description: 選択された入学日（`course_intake_dates`テーブルのID）
      responses:
        '200':
          description: 申請、リクエスト、スケジュールが正常に作成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  request_id:
                    type: string
                    description: Content Snareで作成されたリクエストのID
                  share_link:
                    type: string
                    format: uri
                    description: リクエストへの共有リンク
                  application_id:
                    type: string
                    description: Supabaseで作成されたコース申請のID
                  success:
                    type: boolean
        '400':
          description: 必須パラメータの不足、コースにテンプレートが設定されていない、または入学日が無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 'courseId, clientId, intake_date_idは必須です'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Content Snareの認証情報がない、またはトークンが無効な場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 指定されたコース、ユーザー、または入学日が見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/course-application/details:
    get:
      summary: ユーザーのコース申請詳細を取得
      description: |
        認証済みのユーザーが所有する特定のコース申請の詳細情報を取得します。
        申請情報には、関連するコース情報と入学日情報が含まれます。
        ユーザー自身の申請データにのみアクセス可能です。
      tags:
        - Course-application
      parameters:
        - name: applicationId
          in: query
          required: true
          schema:
            type: string
          description: 取得するコース申請のID
      responses:
        '200':
          description: コース申請の詳細情報が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      application:
                        type: object
                        properties:
                          id:
                            type: string
                          user_id:
                            type: string
                          course_id:
                            type: string
                          status:
                            type: string
                          created_at:
                            type: string
                            format: date-time
                          intake_date_id:
                            type: string
                            nullable: true
                          intake_date:
                            type: object
                            description: 関連する入学日情報
                            properties:
                              id:
                                type: string
                              course_id:
                                type: string
                              start_date:
                                type: string
                                format: date-time
                              application_deadline:
                                type: string
                                format: date-time
                                nullable: true
                              month:
                                type: number
                              day:
                                type: number
                              year:
                                type: number
                              is_tentative:
                                type: boolean
                              notes:
                                type: string
                                nullable: true
                      course:
                        type: object
                        properties:
                          id:
                            type: string
                          name:
                            type: string
                          description:
                            type: string
        '400':
          description: クエリパラメータ `applicationId` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: ユーザーが指定された申請へのアクセス権限を持っていない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 指定された`applicationId`に対応するコース申請またはコース情報が見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/course-application/schedules:
    get:
      summary: 特定のコース申請に関連するスケジュール一覧を取得
      description: |
        特定のコース申請IDに紐づく全てのユーザースケジュールを取得します。
        ユーザーは自身の申請に関連するスケジュールのみアクセス可能です。
        スケジュールは年、月、日、ソート順で昇順に並べ替えられて返されます。
      tags:
        - Course-application
      parameters:
        - name: applicationId
          in: query
          required: true
          schema:
            type: string
          description: スケジュールを取得するコース申請のID
      responses:
        '200':
          description: スケジュール一覧が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        user_id:
                          type: string
                        course_application_id:
                          type: string
                        title:
                          type: string
                        description:
                          type: string
                          nullable: true
                        year:
                          type: number
                        month:
                          type: number
                        day:
                          type: number
                          nullable: true
                        is_admin_locked:
                          type: boolean
                        is_completed:
                          type: boolean
                        created_at:
                          type: string
                          format: date-time
                        updated_at:
                          type: string
                          format: date-time
        '400':
          description: クエリパラメータ `applicationId` が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: ユーザーが指定された申請へのアクセス権限を持っていない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 指定された`applicationId`に対応するコース申請が見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      summary: ユーザーのスケジュールを更新
      description: |
        特定のスケジュールIDに対応するユーザースケジュールを更新します。
        リクエストボディの`action`パラメータによって、完了状態の切り替え、または日付の更新が可能です。
        - **`toggle_completed`**: `completed`パラメータに基づいて`is_completed`を更新します。
        - **`update_date`**: `year`, `month`, `day`パラメータに基づいて日付を更新します。
        この操作には、スケジュールが紐づくコース申請へのアクセス権（自身の申請または管理者権限）が必要です。`is_admin_locked`が`true`の場合、管理者のみが編集できます。
      tags:
        - Course-application
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - applicationId
                - scheduleId
              properties:
                applicationId:
                  type: string
                  description: 更新するスケジュールが紐づくコース申請のID
                scheduleId:
                  type: string
                  description: 更新するスケジュールのID
                action:
                  type: string
                  enum:
                    - toggle_completed
                    - update_date
                  default: toggle_completed
                  description: 実行するアクション。
                completed:
                  type: boolean
                  description: '`action`が`toggle_completed`の場合に必須。スケジュールの新しい完了状態。'
                year:
                  type: number
                  description: '`action`が`update_date`の場合に必須。新しい年。'
                month:
                  type: number
                  description: '`action`が`update_date`の場合に必須。新しい月。'
                day:
                  type: number
                  description: '`action`が`update_date`の場合に必須。新しい日。'
      responses:
        '200':
          description: スケジュールが正常に更新された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    description: 更新されたスケジュールオブジェクト
        '400':
          description: 必須パラメータの不足、または無効なリクエストボディの場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: 権限不足によりスケジュールを更新できない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '404':
          description: 指定された申請またはスケジュールが見つからない場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/course-application/status:
    get:
      summary: 特定のコースに対するユーザーの申請ステータスを取得
      description: |
        認証済みのユーザー（またはクエリパラメータで指定されたユーザー）が、特定のコースに対して行ったコース申請のステータスを取得します。
        申請が存在しない場合は`null`を返します。
      tags:
        - Course-application
      parameters:
        - name: courseId
          in: query
          required: true
          schema:
            type: string
          description: ステータスを取得するコースのID
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: 情報を取得するユーザーのID。指定がない場合は認証済みユーザーIDを使用。
      responses:
        '200':
          description: 申請ステータスが正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    nullable: true
                    properties:
                      id:
                        type: string
                        description: コース申請のID
                      status:
                        type: string
                        description: 申請の現在のステータス
                      content_snare_request_id:
                        type: string
                        description: 関連するContent SnareリクエストのID
        '400':
          description: 必須クエリパラメータ`courseId`が不足している場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/create-customer-portal-session:
    post:
      summary: Stripeカスタマーポータルセッションを作成
      description: |
        Stripeの顧客ID (`customerId`) を使用して、顧客が請求情報やサブスクリプションを管理するためのカスタマーポータルセッションを作成します。
        このAPIは、顧客をStripeのホスト型ポータルページにリダイレクトするために使用されます。
      tags:
        - Create-customer-portal-session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - customerId
              properties:
                customerId:
                  type: string
                  description: Stripeの顧客ID
                  example: cus_1234567890abcdef
      responses:
        '200':
          description: セッションが正常に作成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                    description: 顧客をリダイレクトするためのStripeカスタマーポータルのURL
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/create-subscription:
    post:
      summary: StripeサブスクリプションのCheckoutセッションを作成
      description: |
        指定されたユーザーID (`userId`) に対して、新しいStripeサブスクリプションのためのCheckoutセッションを作成します。
        このAPIは、ユーザーがすでにアクティブなサブスクリプションを持っていないことを確認し、指定された価格IDでサブスクリプションをセットアップします。
        ユーザーはStripeのCheckoutページにリダイレクトされ、支払いを完了できます。
      tags:
        - Create-subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: サブスクリプションを作成するユーザーのSupabaseユーザーID
                  example: abcde-12345-fghij-67890
      responses:
        '200':
          description: Checkoutセッションが正常に作成された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    description: 作成されたStripe CheckoutセッションのID
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/events:
    get:
      summary: Google Calendarのイベントを取得
      description: |
        指定された年と月にGoogle Calendarからイベントを取得します。
        このAPIは、Supabaseに保存されているGoogleのリフレッシュトークンを使用して、認証とAPI呼び出しを行います。
        トークンが存在しない場合はイベントを取得できません。
        クエリパラメータで年と月を指定しない場合、現在の日付が使用されます。
      tags:
        - Events
      parameters:
        - name: month
          in: query
          required: false
          schema:
            type: string
          description: イベントを取得する月（1-12）
        - name: year
          in: query
          required: false
          schema:
            type: string
          description: イベントを取得する年
      responses:
        '200':
          description: イベントが正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    description: Google Calendarから取得したイベントのリスト
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        summary:
                          type: string
                          description: イベントのタイトル
                        start:
                          type: object
                          properties:
                            dateTime:
                              type: string
                              format: date-time
                              nullable: true
                            date:
                              type: string
                              format: date
                              nullable: true
                        end:
                          type: object
                          properties:
                            dateTime:
                              type: string
                              format: date-time
                              nullable: true
                            date:
                              type: string
                              format: date
                              nullable: true
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/job-positions:
    get:
      summary: 全ての職種データを取得
      description: |
        データベースの`job_positions`テーブルから、全ての職種データ（役職、説明など）を一覧で取得します。
        結果は役職名（`title`）でソートされて返されます。
      tags:
        - Job-positions
      responses:
        '200':
          description: 職種データの一覧が正常に取得された場合の応答
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: 職種ID
                    title:
                      type: string
                      description: 役職名
                    description:
                      type: string
                      description: 職種の説明
                    created_at:
                      type: string
                      format: date-time
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/microcms:
    get:
      summary: MicroCMSのコンテンツを統合的に取得
      description: |
        MicroCMSからブログ記事、インタビュー、コース情報などの様々なコンテンツを取得する統合APIです。
        `type`クエリパラメータによって取得するコンテンツを切り替え、`limit`、`offset`、`category`などのパラメータで取得内容を制御できます。
        デフォルトでは、複数のコンテンツタイプ（ブログ、インタビュー、注目コース）を一度に取得します。
        すべてのリクエストには、キャッシュ制御のためのヘッダーが付与されます。
      tags:
        - MicroCMS
      parameters:
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum:
              - blog
              - interview
              - course
              - all
            default: all
          description: 取得するコンテンツのタイプ。
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
          description: 取得するコンテンツの数。
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
          description: 取得を開始するオフセット。
        - name: category
          in: query
          required: false
          schema:
            type: string
          description: 取得するブログ記事のカテゴリー。
        - name: slug
          in: query
          required: false
          schema:
            type: string
          description: 特定のブログ記事を取得するためのスラッグ。`type=blog`の場合に有効。
        - name: id
          in: query
          required: false
          schema:
            type: string
          description: 特定のコース情報を取得するためのID。`type=course`の場合に有効。
        - name: ttl
          in: query
          required: false
          schema:
            type: integer
            default: 3600
          description: キャッシュの有効期限（秒）。
        - name: revalidate
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: キャッシュを強制的に再検証するかどうか。
      responses:
        '200':
          description: コンテンツが正常に取得された場合の応答
          content:
            application/json:
              schema:
                oneOf:
                  - type: array
                    items: {}
                  - type: object
                    properties: {}
                  - type: object
                    properties:
                      blog:
                        type: object
                        properties:
                          contents:
                            type: array
                            items: {}
                          totalCount:
                            type: integer
                      interviews:
                        type: object
                        properties:
                          contents:
                            type: array
                            items: {}
                          totalCount:
                            type: integer
                      courses:
                        type: object
                        properties:
                          contents:
                            type: array
                            items: {}
                          totalCount:
                            type: integer
        '500':
          $ref: '#/components/responses/InternalServerError'
components:
  responses:
    BadRequest:
      description: リクエストの形式が不正です。必須パラメータの不足や値の形式が間違っています。
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: 質問が指定されていません
    UnauthorizedError:
      description: 認証エラー。有効な認証情報が提供されていません。
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: 認証情報が不正です
    NotFound:
      description: 指定したリソースが見つかりません。
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: リソースが見つかりません
    InternalServerError:
      description: サーバーエラー。予期せぬ問題が発生しました。
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: 予期せぬエラーが発生しました
